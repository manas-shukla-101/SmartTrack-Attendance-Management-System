<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Teacher Dashboard • Attendance System
  </title>
  <!-- Poppins Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2Pkf1R5dGQ3vFhZq8FfGLwZlYx2hZt+8ig2py4G6kT07QfY6XJ8Rk8fLwQ==" referrerpolicy="no-referrer" rel="stylesheet">
   <!-- SweetAlert2 -->
   <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.min.css" rel="stylesheet">
    <!-- Global Theme CSS -->
    <link href="style.css" rel="stylesheet"/>
    <!-- Page-specific CSS -->
    <link href="teacher_dashboard.css" rel="stylesheet"/>
    <style>
     body { font-family: 'Poppins', var(--font-sans, system-ui), -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
    </style>
   </link>
  </link>
 </head>
 <body>
  <!-- Header (GlobalHeader) -->
  <!-- Teacher Header with Quick Action -->
  <nav aria-label="Global Teacher Header" class="teacher-header navbar navbar-expand-lg sticky-top px-3">
   <a class="navbar-brand d-flex align-items-center" href="./teacher_dashboard.html">
    <img alt="School Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/schoollogo/56/56';" src="https://img.freepik.com/free-vector/branding-identity-corporate-vector-logo-m-design_460848-10168.jpg" style="height:28px"/>
    <span class="fw-semibold">
     Teacher
    </span>
   </a>
   <div class="ms-3 d-none d-md-block">
    <a class="btn" href="./attendance_roster.html" style="background:var(--primary); color:#fff;">
     <i class="fa-solid fa-clipboard-check me-2">
     </i>
     Start Attendance
    </a>
   </div>
   <button aria-controls="hdrNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler ms-auto" data-bs-target="#hdrNav" data-bs-toggle="collapse" type="button">
    <span class="navbar-toggler-icon">
    </span>
   </button>
   <div class="collapse navbar-collapse" id="hdrNav">
    <ul class="navbar-nav ms-auto align-items-center">
     <li class="nav-item me-2">
      <a class="nav-link position-relative" data-bs-title="Notifications" data-bs-toggle="tooltip" href="#" id="notifBell">
       <i class="fa-solid fa-bell">
       </i>
       <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
        2
       </span>
      </a>
     </li>
     <li class="nav-item me-2 d-none d-md-block">
      <a class="nav-link" data-bs-title="Messages" data-bs-toggle="tooltip" href="#">
       <i class="fa-solid fa-envelope">
       </i>
      </a>
     </li>
     <li class="nav-item dropdown">
      <a aria-expanded="false" class="nav-link dropdown-toggle d-flex align-items-center" data-bs-toggle="dropdown" href="#">
       <img alt="Avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/teacher/32/32';" src="https://via.placeholder.com/32"/>
       <span id="hdrUserName">
        Teacher
       </span>
      </a>
      <ul class="dropdown-menu dropdown-menu-end">
       <li>
        <a class="dropdown-item" href="./attendance_history.html">
         <i class="fa-solid fa-history me-2">
         </i>
         My Classes History
        </a>
       </li>
       <li>
        <hr class="dropdown-divider"/>
       </li>
       <li>
        <button class="dropdown-item" id="btnLogout">
         <i class="fa-solid fa-right-from-bracket me-2">
         </i>
         Logout
        </button>
       </li>
      </ul>
     </li>
    </ul>
   </div>
  </nav>
  <!-- Main Layout: Sidebar + Content -->
  <div class="d-flex" id="appLayout">
   <!-- Sidebar (left) -->
   <!-- Teacher Sidebar -->
   <nav class="teacher-sidebar d-flex flex-column">
    <div class="brand d-flex align-items-center p-3">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/36/36';" src="https://img.freepik.com/free-vector/branding-identity-corporate-vector-logo-m-design_460848-10168.jpg" style="height:36px;">
      <div class="fw-bold">
       Teacher Portal
      </div>
     </img>
    </div>
    <div class="p-3 border-bottom">
     <div class="d-flex align-items-center">
      <img alt="Avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/avatar/40/40';" src="https://via.placeholder.com/40">
       <div>
        <div class="fw-semibold" id="sbTeacherName">
         Teacher Name
        </div>
        <small class="text-muted">
         Teacher
        </small>
       </div>
      </img>
     </div>
    </div>
    <div class="flex-grow-1 overflow-auto">
     <ul class="nav flex-column mt-2">
      <li class="nav-item">
       <a class="nav-link active" href="./teacher_dashboard.html">
        <i class="fa-solid fa-gauge me-2">
        </i>
        Dashboard
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./attendance_roster.html">
        <i class="fa-solid fa-clipboard-check me-2">
        </i>
        Take Attendance
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./attendance_history.html">
        <i class="fa-solid fa-history me-2">
        </i>
        Attendance History
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./correction_form.html">
        <i class="fa-solid fa-pen-to-square me-2">
        </i>
        Request Correction
       </a>
      </li>
      <li class="nav-item">
       <a class="nav-link" href="./substitute_dashboard.html">
        <i class="fa-solid fa-user-group me-2">
        </i>
        Substitute Access
       </a>
      </li>
     </ul>
    </div>
    <div class="p-3">
     <a class="btn btn-outline-secondary w-100" href="./index.html">
      <i class="fa-solid fa-right-from-bracket me-2">
      </i>
      Logout
     </a>
    </div>
   </nav>
   <!-- Main Content -->
   <main class="flex-grow-1 main-panel">
    <!-- Page Header -->
    <div class="page-header mb-3 align-items-center">
     <div class="d-flex align-items-center gap-3">
      <div>
       <div class="page-title">
        Welcome back,
        <span id="pageTeacherName">
         Teacher Name
        </span>
       </div>
       <div class="text-muted" id="currentDateText">
        Today
       </div>
      </div>
     </div>
     <div class="d-flex align-items-center gap-2">
      <div aria-label="View switcher" class="view-switcher" role="group">
       <div class="option active" id="switchList" title="List view">
        <i class="fa-solid fa-list">
        </i>
       </div>
       <div class="option" id="switchTiles" title="Tiles view">
        <i class="fa-solid fa-table-cells">
        </i>
       </div>
      </div>
      <a class="btn btn-light" href="./calendar_settings.html">
       <i class="fa-regular fa-calendar me-2">
       </i>
       Calendar Settings
      </a>
     </div>
    </div>
    <!-- Filters / Controls -->
    <div class="app-card p-3 mb-4">
     <div class="row g-2 align-items-end">
      <div class="col-12 col-md-4">
       <label class="form-label" for="filterDate">
        Date
       </label>
       <input class="form-control" id="filterDate" type="date"/>
      </div>
      <div class="col-12 col-md-4">
       <label class="form-label" for="filterStatus">
        Attendance Status
       </label>
       <select class="form-select" id="filterStatus">
        <option selected="" value="all">
         All
        </option>
        <option value="Pending">
         Pending
        </option>
        <option value="Submitted">
         Submitted
        </option>
        <option value="Late">
         Late
        </option>
       </select>
      </div>
      <div class="col-12 col-md-4">
       <label class="form-label" for="searchClass">
        Search
       </label>
       <div class="input-group">
        <span class="input-group-text">
         <i class="fa-solid fa-magnifying-glass">
         </i>
        </span>
        <input class="form-control" id="searchClass" placeholder="Course name or period..." type="text"/>
       </div>
      </div>
     </div>
    </div>
    <div class="row g-4">
     <!-- Daily Class Schedule -->
     <div class="col-12 col-lg-8">
      <div class="card">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-clock text-primary">
         </i>
         <span class="widget-title">
          Today's Classes
         </span>
        </div>
        <div class="text-muted small" id="nowTime">
         --:--
        </div>
       </div>
       <div class="card-body">
        <!-- Loading state -->
        <div class="loading-state" id="scheduleLoading">
         <div class="skeleton" style="height: 18px; margin-bottom: 10px;">
         </div>
         <div class="skeleton" style="height: 100px; margin-bottom: 10px;">
         </div>
         <div class="skeleton" style="height: 100px; margin-bottom: 10px;">
         </div>
        </div>
        <!-- Empty state -->
        <div class="empty-state d-none" id="scheduleEmpty">
         <i class="fa-regular fa-calendar-xmark fa-2x text-muted">
         </i>
         <div>
          No classes scheduled for this day.
         </div>
        </div>
        <!-- Schedule list -->
        <div aria-live="polite" class="vstack gap-3 d-none" id="scheduleList">
        </div>
       </div>
       <div class="card-footer d-flex justify-content-between align-items-center">
        <small class="text-muted" id="scheduleMeta">
         0 classes • Sorted by start time
        </small>
        <div>
         <button class="btn btn-light btn-sm" id="btnResetFilters">
          <i class="fa-solid fa-rotate-left me-1">
          </i>
          Reset Filters
         </button>
        </div>
       </div>
      </div>
      <!-- Recent Corrections Table -->
      <div class="card mt-4">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-pen-to-square text-secondary">
         </i>
         <span class="widget-title">
          Recent Attendance Corrections
         </span>
        </div>
        <div class="d-none d-md-flex align-items-center gap-2">
         <input class="form-control form-control-sm" id="corrSearch" placeholder="Search..." style="max-width: 200px;" type="text"/>
        </div>
       </div>
       <div class="card-body p-0">
        <div class="table-responsive">
         <table class="table table-theme mb-0" id="correctionsTable">
          <thead>
           <tr>
            <th data-sort="date" role="button">
             Date
             <i class="fa-solid fa-sort ms-1">
             </i>
            </th>
            <th>
             Period
            </th>
            <th>
             Course
            </th>
            <th>
             Submitted
            </th>
            <th>
             Status
            </th>
            <th>
             Actions
            </th>
           </tr>
          </thead>
          <tbody>
           <!-- rows injected by JS -->
          </tbody>
         </table>
        </div>
       </div>
       <div class="card-footer d-flex justify-content-between align-items-center">
        <small class="text-muted" id="corrMeta">
         Showing 0–0 of 0
        </small>
        <div class="d-flex align-items-center gap-2">
         <button class="btn btn-light btn-sm" disabled="" id="corrPrev">
          <i class="fa-solid fa-angle-left">
          </i>
         </button>
         <span class="small" id="corrPage">
          1
         </span>
         <button class="btn btn-light btn-sm" disabled="" id="corrNext">
          <i class="fa-solid fa-angle-right">
          </i>
         </button>
        </div>
       </div>
      </div>
     </div>
     <!-- Alerts + Quick Actions + Chart -->
     <div class="col-12 col-lg-4">
      <!-- Alerts Panel -->
      <div class="card mb-4">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-bell text-error">
         </i>
         <span class="widget-title">
          Alerts
         </span>
        </div>
        <button class="btn btn-light btn-sm" id="btnDismissAll">
         <i class="fa-regular fa-circle-xmark me-1">
         </i>
         Dismiss All
        </button>
       </div>
       <div class="card-body">
        <div class="loading-state" id="alertsLoading">
         <div class="skeleton" style="height: 60px; margin-bottom: 10px;">
         </div>
         <div class="skeleton" style="height: 60px; margin-bottom: 10px;">
         </div>
        </div>
        <ul class="list-group list-group-flush d-none" id="alertsList">
         <!-- notifications injected -->
        </ul>
        <div class="empty-state d-none" id="alertsEmpty">
         <div class="text-muted">
          No new alerts
         </div>
        </div>
       </div>
      </div>
      <!-- Quick Actions -->
      <div class="card mb-4">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-bolt text-warning">
         </i>
         <span class="widget-title">
          Quick Actions
         </span>
        </div>
       </div>
       <div class="card-body">
        <div class="d-grid gap-2">
         <a class="btn btn-primary" href="./attendance_history.html">
          <i class="fa-solid fa-clock-rotate-left me-2">
          </i>
          View Full History
         </a>
         <a class="btn btn-info" href="./substitute_dashboard.html">
          <i class="fa-solid fa-user-group me-2">
          </i>
          Substitute Access
         </a>
         <a class="btn btn-warning" href="./correction_form.html">
          <i class="fa-solid fa-pen-to-square me-2">
          </i>
          Request Correction
         </a>
        </div>
       </div>
      </div>
      <!-- Mini Chart: Submission Rate -->
      <div class="card">
       <div class="card-header">
        <div class="title d-flex align-items-center gap-2">
         <i class="fa-solid fa-chart-line text-success">
         </i>
         <span class="widget-title">
          Weekly Submission Rate
         </span>
        </div>
       </div>
       <div class="card-body">
        <canvas aria-label="Weekly submission rate chart" height="220" id="submissionChart" role="img">
        </canvas>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
  <!-- Footer -->
  <footer class="teacher-footer py-2 px-3 d-flex align-items-center justify-content-between">
   <div class="d-flex align-items-center">
    <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/footerlogo/18/18';" src="https://img.freepik.com/free-vector/branding-identity-corporate-vector-logo-m-design_460848-10168.jpg" style="height:18px"/>
    <small class="text-muted">
     © 2025 Attendance System
    </small>
   </div>
   <div>
    <a class="text-decoration-none me-3" href="#">
     Terms
    </a>
    <a class="text-decoration-none" href="#">
     Privacy
    </a>
   </div>
  </footer>
  <!-- Toasts Container -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
   <div aria-atomic="true" aria-live="assertive" class="toast align-items-center text-bg-primary border-0" id="appToast" role="alert">
    <div class="d-flex">
     <div class="toast-body" id="toastBody">
      Action completed
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- Bootstrap 5 JS -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js">
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js">
  </script>
  <script>
   // Demo Session Data
const teacherName = 'Alex Johnson';

// Mock Classes (today)
let classes = [{
    id: 'P1',
    courseName: 'Algebra I',
    period: 1,
    start: '08:00',
    end: '08:50',
    students: 28,
    submitted: true
}, {
    id: 'P2',
    courseName: 'Geometry',
    period: 2,
    start: '09:00',
    end: '09:50',
    students: 30,
    submitted: false
}, {
    id: 'P3',
    courseName: 'Advisory',
    period: 3,
    start: '10:05',
    end: '10:35',
    students: 30,
    submitted: true
}, {
    id: 'P4',
    courseName: 'Algebra II',
    period: 4,
    start: '10:45',
    end: '11:35',
    students: 27,
    submitted: false
}, {
    id: 'P5',
    courseName: 'Pre-Calculus',
    period: 5,
    start: '12:20',
    end: '13:10',
    students: 25,
    submitted: false
}, {
    id: 'P6',
    courseName: 'Math Lab',
    period: 6,
    start: '13:20',
    end: '14:10',
    students: 22,
    submitted: false
}];

// Mock Alerts
const alerts = [{
    id: 1,
    type: 'alert',
    message: 'Jane Doe has reached 5 unexcused absences.',
    time: '10m ago',
    link: './attendance_history.html'
}, {
    id: 2,
    type: 'info',
    message: 'Your attendance correction for Period 2 on 09/15 has been approved.',
    time: '2h ago',
    link: './attendance_history.html'
}];

// Mock Corrections Table Data
const correctionRows = [{
    date: '2025-09-18',
    period: 2,
    course: 'Geometry',
    submitted: '2025-09-18 11:10',
    status: 'Approved'
}, {
    date: '2025-09-16',
    period: 4,
    course: 'Algebra II',
    submitted: '2025-09-16 12:05',
    status: 'Pending'
}, {
    date: '2025-09-15',
    period: 1,
    course: 'Algebra I',
    submitted: '2025-09-15 08:55',
    status: 'Rejected'
}, {
    date: '2025-09-12',
    period: 5,
    course: 'Pre-Calculus',
    submitted: '2025-09-12 13:15',
    status: 'Approved'
}, {
    date: '2025-09-11',
    period: 6,
    course: 'Math Lab',
    submitted: '2025-09-11 14:12',
    status: 'Approved'
}, {
    date: '2025-09-09',
    period: 3,
    course: 'Advisory',
    submitted: '2025-09-09 10:40',
    status: 'Pending'
}];

// Utilities
const $ = (sel, root = document) => root.querySelector(sel);
const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

const pad = n => (n < 10 ? '0' + n : '' + n);

function formatNow() {
    const d = new Date();
    const h = pad(d.getHours());
    const m = pad(d.getMinutes());
    return `${h}:${m}`;
}

function setHeaderInfo() {
    $('#hdrUserName').textContent = teacherName;
    $('#sbTeacherName').textContent = teacherName;
    $('#pageTeacherName').textContent = teacherName;
    const now = new Date();
    const dateText = now.toLocaleDateString(undefined, {
        weekday: 'long',
        month: 'short',
        day: 'numeric'
    });
    $('#currentDateText').textContent = `Today • ${dateText}`;
    $('#nowTime').textContent = formatNow();
}

function getTodayDateInputValue() {
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function timeToMinutes(t) {
    const [h, m] = t.split(':').map(Number);
    return h * 60 + m;
}

function computeStatus(cls) {
    const now = new Date();
    const nowMin = now.getHours() * 60 + now.getMinutes();
    const startMin = timeToMinutes(cls.start);
    const endMin = timeToMinutes(cls.end);
    const isCurrent = nowMin >= startMin && nowMin <= endMin;
    const isUpcoming = nowMin < startMin && startMin - nowMin <= 30; // within 30m
    let status = 'Pending';
    if (cls.submitted) status = 'Submitted';
    else if (!cls.submitted && nowMin > endMin) status = 'Late';
    return {
        status,
        isCurrent,
        isUpcoming
    };
}

function badgeForStatus(status) {
    const map = {
        'Pending': '<span class="badge-soft warning"><span class="status-dot warning"></span>Pending</span>',
        'Submitted': '<span class="badge-soft success"><span class="status-dot success"></span>Submitted</span>',
        'Late': '<span class="badge-soft error"><span class="status-dot error"></span>Late</span>'
    };
    return map[status] || status;
}

function actionLabel(status) {
    return status === 'Submitted' ? 'View/Edit Attendance' : 'Take Attendance';
}

function renderClassCard(cls) {
    const meta = computeStatus(cls);
    const highlight = meta.isCurrent ? 'current' : (meta.isUpcoming ? 'upcoming' : '');
    const disabled = (!meta.isCurrent && meta.status === 'Pending' && !meta.isUpcoming);
    const btnAttr = disabled ? 'disabled aria-disabled="true"' : '';
    const hint = meta.isCurrent ? 'In progress' : (meta.isUpcoming ? 'Starting soon' : '');
    return `
        <div class="app-card class-card ${highlight}" data-id="${cls.id}">
          <div class="d-flex justify-content-between align-items-start">
            <div class="d-flex flex-column">
              <div class="fw-bold">${cls.courseName} <span class="text-muted">• Period ${cls.period}</span></div>
              <div class="text-muted"><i class="fa-regular fa-clock me-1"></i>${cls.start} – ${cls.end} ${hint ? `• <span class="text-info">${hint}</span>` : ''}</div>
              <div class="mt-1"><small class="text-muted"><i class="fa-solid fa-user-graduate me-1"></i>${cls.students} students</small></div>
            </div>
            <div class="text-end">
              ${badgeForStatus(meta.status)}
            </div>
          </div>
          <div class="mt-3 d-flex justify-content-end">
            <button class="btn ${meta.status==='Submitted' ? 'btn-secondary' : 'btn-primary'} btn-sm btn-take" data-id="${cls.id}" ${btnAttr}>
              <i class="fa-solid ${meta.status==='Submitted' ? 'fa-folder-open' : 'fa-clipboard-check'} me-2"></i>${actionLabel(meta.status)}
            </button>
          </div>
        </div>
      `;
}

function applyFilters(data) {
    const status = $('#filterStatus').value;
    const term = $('#searchClass').value.trim().toLowerCase();
    return data
        .filter(c => status === 'all' || computeStatus(c).status === status)
        .filter(c => !term || c.courseName.toLowerCase().includes(term) || String(c.period).includes(term))
        .sort((a, b) => timeToMinutes(a.start) - timeToMinutes(b.start));
}

function renderSchedule() {
    const list = $('#scheduleList');
    const filtered = applyFilters(classes);
    list.innerHTML = filtered.map(renderClassCard).join('');
    $('#scheduleMeta').textContent = `${filtered.length} ${filtered.length===1 ? 'class' : 'classes'} • Sorted by start time`;
    if (filtered.length === 0) {
        $('#scheduleList').classList.add('d-none');
        $('#scheduleEmpty').classList.remove('d-none');
    } else {
        $('#scheduleEmpty').classList.add('d-none');
        $('#scheduleList').classList.remove('d-none');
    }

    // activate tooltips in newly rendered cards
    initTooltips();
}

function initTooltips() {
    $$('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
}

function showToast(message, variant = 'primary') {
    const toastEl = $('#appToast');
    toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
    $('#toastBody').textContent = message;
    const t = new bootstrap.Toast(toastEl, {
        delay: 2500
    });
    t.show();
}

function wireEvents() {
    // Filters
    $('#filterStatus').addEventListener('change', renderSchedule);
    $('#searchClass').addEventListener('input', renderSchedule);
    $('#btnResetFilters').addEventListener('click', () => {
        $('#filterDate').value = getTodayDateInputValue();
        $('#filterStatus').value = 'all';
        $('#searchClass').value = '';
        renderSchedule();
        showToast('Filters reset', 'secondary');
    });

    // Schedule action buttons (delegate)
    $('#scheduleList').addEventListener('click', (e) => {
        const btn = e.target.closest('.btn-take');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        const cls = classes.find(c => c.id === id);
        const {
            status
        } = computeStatus(cls);
        const label = actionLabel(status);
        Swal.fire({
            title: label,
            text: `${cls.courseName} • Period ${cls.period} (${cls.start}–${cls.end})`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Go to Roster',
            cancelButtonText: 'Cancel'
        }).then(res => {
            if (res.isConfirmed) {
                window.location.href = `./attendance_roster.html?classId=${encodeURIComponent(id)}`;
            }
        });
    });

    // Dismiss all alerts
    $('#btnDismissAll').addEventListener('click', () => {
        Swal.fire({
            title: 'Dismiss all alerts?',
            text: 'You can still view them later in History.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#f08e1b',
            confirmButtonText: 'Dismiss All'
        }).then(res => {
            if (res.isConfirmed) {
                $('#alertsList').innerHTML = '';
                $('#alertsList').classList.add('d-none');
                $('#alertsEmpty').classList.remove('d-none');
                showToast('All alerts dismissed', 'warning');
            }
        });
    });

    // Header actions
    $('#btnLogout').addEventListener('click', () => {
        Swal.fire({
            title: 'Logout?',
            text: 'You will be returned to the login page.',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Logout'
        }).then(res => {
            if (res.isConfirmed) {
                // Clear session (demo)
                // localStorage.clear(); sessionStorage.clear();
                window.location.href = './index.html';
            }
        });
    });

    // Corrections table sorting & pagination (simple demo)
    $('#corrSearch').addEventListener('input', () => renderCorrections());
    $('#correctionsTable thead').addEventListener('click', (e) => {
        const th = e.target.closest('[data-sort]');
        if (!th) return;
        const key = th.dataset.sort;
        correctionsSort.key = key;
        correctionsSort.asc = !correctionsSort.asc;
        renderCorrections();
    });
    $('#corrPrev').addEventListener('click', () => {
        if (corrPage > 1) {
            corrPage--;
            renderCorrections();
        }
    });
    $('#corrNext').addEventListener('click', () => {
        if (corrPage < corrTotalPages) {
            corrPage++;
            renderCorrections();
        }
    });

    // View switcher styling demo
    $('#switchList').addEventListener('click', () => {
        $('#switchList').classList.add('active');
        $('#switchTiles').classList.remove('active');
        document.body.classList.remove('view-tiles');
        document.body.classList.add('view-grid');
    });
    $('#switchTiles').addEventListener('click', () => {
        $('#switchTiles').classList.add('active');
        $('#switchList').classList.remove('active');
        document.body.classList.remove('view-grid');
        document.body.classList.add('view-tiles');
    });
}

// Alerts rendering
function renderAlerts() {
    const list = $('#alertsList');
    if (!alerts.length) {
        $('#alertsLoading').classList.add('d-none');
        $('#alertsEmpty').classList.remove('d-none');
        return;
    }
    list.innerHTML = alerts.map(a => `
        <li class="list-group-item d-flex justify-content-between align-items-start">
          <div class="me-2">
            <div class="${a.type==='alert' ? 'text-danger' : 'text-info'} fw-semibold">
              <i class="fa-solid ${a.type==='alert' ? 'fa-triangle-exclamation' : 'fa-circle-info'} me-1"></i>
              ${a.type==='alert' ? 'Alert' : 'Info'}
            </div>
            <div class="mt-1">${a.message}</div>
            <small class="text-muted">${a.time}</small>
          </div>
          <div class="d-flex flex-column gap-2">
            <a href="${a.link}" class="btn btn-light btn-sm" title="Open related"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
          </div>
        </li>
      `).join('');
    $('#alertsLoading').classList.add('d-none');
    list.classList.remove('d-none');
}

// Corrections table render
let correctionsSort = {
    key: 'date',
    asc: false
};
let corrPage = 1;
let corrPageSize = 6;
let corrTotalPages = 1;

function renderCorrections() {
    const term = $('#corrSearch').value.trim().toLowerCase();
    let rows = correctionRows.filter(r => !term ||
        r.course.toLowerCase().includes(term) ||
        String(r.period).includes(term) || r.status.toLowerCase().includes(term) || r.date.includes(term)
    );

    rows.sort((a, b) => {
        const k = correctionsSort.key;
        const va = a[k];
        const vb = b[k];
        if (k === 'date' || k === 'submitted') {
            const da = new Date(va);
            const db = new Date(vb);
            return correctionsSort.asc ? (da - db) : (db - da);
        }
        if (va < vb) return correctionsSort.asc ? -1 : 1;
        if (va > vb) return correctionsSort.asc ? 1 : -1;
        return 0;
    });

    corrTotalPages = Math.max(1, Math.ceil(rows.length / corrPageSize));
    if (corrPage > corrTotalPages) corrPage = corrTotalPages;
    const start = (corrPage - 1) * corrPageSize;
    const pageRows = rows.slice(start, start + corrPageSize);

    const tbody = $('#correctionsTable tbody');
    tbody.innerHTML = pageRows.map(r => `
        <tr>
          <td>${new Date(r.date).toLocaleDateString()}</td>
          <td>${r.period}</td>
          <td>${r.course}</td>
          <td>${new Date(r.submitted).toLocaleString()}</td>
          <td>
            <span class="badge-soft ${r.status==='Approved' ? 'success' : (r.status==='Pending' ? 'warning' : 'error')}">${r.status}</span>
          </td>
          <td>
            <a href="./attendance_history.html" class="btn btn-light btn-sm"><i class="fa-solid fa-eye"></i></a>
          </td>
        </tr>
      `).join('');

    $('#corrMeta').textContent = `Showing ${rows.length ? (start+1) : 0}–${Math.min(start + pageRows.length, rows.length)} of ${rows.length}`;
    $('#corrPage').textContent = `${corrPage}/${corrTotalPages}`;
    $('#corrPrev').disabled = corrPage <= 1;
    $('#corrNext').disabled = corrPage >= corrTotalPages;
}

// Chart
function renderChart() {
    const ctx = document.getElementById('submissionChart');
    if (!ctx) return;
    const data = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Submissions %',
            data: [92, 100, 96, 88, 100, 0, 0],
            fill: true,
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--color-success') || '#00774E',
            backgroundColor: 'rgba(0, 119, 78, 0.12)',
            tension: 0.35,
            pointRadius: 3,
            pointHoverRadius: 5
        }]
    };
    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--divider-color') || '#e0e0e1';
    new Chart(ctx, {
        type: 'line',
        data,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: (v) => v + '%'
                    },
                    grid: {
                        color: gridColor
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            }
        }
    });
}

// Initialization
document.addEventListener('DOMContentLoaded', () => {
    setHeaderInfo();
    initTooltips();

    // Set date control to today
    $('#filterDate').value = getTodayDateInputValue();

    // Simulate loading
    setTimeout(() => {
        $('#scheduleLoading').classList.add('d-none');
        renderSchedule();
    }, 700);

    // Alerts loading
    setTimeout(() => {
        renderAlerts();
    }, 600);

    renderCorrections();
    renderChart();
    wireEvents();

    // Update clock every minute
    setInterval(() => {
        $('#nowTime').textContent = formatNow();
        renderSchedule();
    }, 60000);

    // Demo: click bell shows a SweetAlert summary
    $('#notifBell').addEventListener('click', (e) => {
        e.preventDefault();
        Swal.fire({
            title: 'Notifications',
            html: alerts.map(a => `<div class='text-start mb-2'><span class='badge-soft ${a.type==='alert' ? 'error' : 'info'} me-2'>${a.type}</span>${a.message}<div class='text-muted small'>${a.time}</div></div>`).join(''),
            confirmButtonText: 'Close'
        });
    });
});
  </script>
 </body>
</html>
