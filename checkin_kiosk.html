<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Check-in Kiosk
  </title>
  <!-- Brand Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" referrerpolicy="no-referrer" rel="stylesheet">
   <!-- SweetAlert2 -->
   <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11">
   </script>
   <!-- Site Theme -->
   <link href="style.css" rel="stylesheet"/>
   <!-- Page-specific CSS -->
   <link href="checkin_kiosk.css" rel="stylesheet"/>
  </link>
 </head>
 <body class="kiosk-shell">
  <!-- Kiosk Sidebar (hidden/minimal for kiosk mode) -->
  <nav class="kiosk-sidebar">
  </nav>
  <!-- Kiosk Header with Branding and Clock (common component) -->
  <nav class="kiosk-header navbar px-3 py-2 d-flex align-items-center justify-content-between">
   <div class="d-flex align-items-center">
    <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/kiosklogo/120/36?grayscale';" src="https://img.freepik.com/free-vector/branding-identity-corporate-vector-logo-m-design_460848-10168.jpg" style="height:36px"/>
    <span class="fw-bold">
     Check-in Kiosk
    </span>
   </div>
   <div class="d-flex align-items-center">
    <i class="fa-solid fa-clock me-2">
    </i>
    <span class="fw-semibold" id="kioskClock">
    </span>
   </div>
  </nav>
  <!-- Main Kiosk Content -->
  <main class="kiosk-main container-max d-flex flex-column gap-4 py-3">
   <!-- 1) Class Information Header (display panel) -->
   <section class="app-card p-3 p-md-4" id="classInfo">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
     <div class="d-flex align-items-center gap-3">
      <div class="class-logo rounded border p-2 bg-white">
       <img alt="School Logo" height="64" onerror="this.onerror=null;this.src='https://picsum.photos/seed/school/80/80?grayscale'" src="https://img.freepik.com/free-vector/branding-identity-corporate-vector-logo-m-design_460848-10168.jpg" width="64"/>
      </div>
      <div>
       <h1 class="m-0 class-title">
        Loading course…
       </h1>
       <div class="text-muted mt-1 small">
        <span id="teacherName">
         —
        </span>
        <span class="mx-2">
         •
        </span>
        <span id="periodInfo">
         —
        </span>
       </div>
      </div>
     </div>
     <div class="d-flex align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-2">
       <span class="status-dot success" id="connDot" title="Connected">
       </span>
       <span class="small text-muted" id="connText">
        Connected
       </span>
      </div>
      <div class="badge-soft info">
       <i class="fa-solid fa-location-dot">
       </i>
       <span id="locationName">
        Kiosk A - North Entrance
       </span>
      </div>
     </div>
    </div>
   </section>
   <!-- 2) Scanning Area (center) -->
   <section class="scanner-section flex-grow-1 d-flex align-items-center justify-content-center">
    <div class="scanner-container text-center">
     <div class="mb-3">
      <p class="lead fw-semibold m-0">
       Scan your Student ID to check in.
      </p>
      <small class="text-muted">
       Most scanners type the ID automatically and press Enter.
      </small>
     </div>
     <!-- Viewfinder -->
     <div class="scanner-viewfinder mx-auto">
      <div class="scanner-corners">
       <span class="corner tl">
       </span>
       <span class="corner tr">
       </span>
       <span class="corner bl">
       </span>
       <span class="corner br">
       </span>
      </div>
      <div aria-hidden="true" class="scanner-line">
      </div>
      <div class="ready-indicator d-flex align-items-center justify-content-center">
       <i class="fa-solid fa-qrcode me-2">
       </i>
       <span id="scannerStatusText">
        Ready for scan
       </span>
      </div>
     </div>
     <!-- Hidden input for hardware/keyboard wedge scanners -->
     <input aria-hidden="true" autocomplete="off" id="scanInput" inputmode="none" type="text"/>
     <!-- Actions -->
     <div class="mt-3 d-flex align-items-center justify-content-center gap-2 flex-wrap">
      <button class="btn btn-primary" id="simulateScanBtn">
       <i class="fa-solid fa-wand-magic-sparkles me-2">
       </i>
       Simulate Scan
      </button>
      <button class="btn btn-light" id="refocusBtn">
       <i class="fa-solid fa-bullseye me-2">
       </i>
       Refocus Scanner
      </button>
     </div>
    </div>
   </section>
   <!-- 3) Scan Result Feedback (dynamic bottom area) -->
   <section aria-atomic="true" aria-live="polite" class="feedback-section" id="feedbackArea">
    <div class="feedback-panel success d-none" id="feedbackSuccess">
     <div class="d-flex align-items-center gap-3">
      <i class="fa-solid fa-circle-check fa-2xl text-success">
      </i>
      <div>
       <div class="fw-bold">
        Welcome,
        <span id="fbStudentName">
         Student
        </span>
        !
       </div>
       <small class="text-muted">
        Checked in at
        <span id="fbCheckinTime">
         --:--:--
        </span>
       </small>
      </div>
     </div>
    </div>
    <div class="feedback-panel error d-none" id="feedbackError">
     <div class="d-flex align-items-center gap-3">
      <i class="fa-solid fa-triangle-exclamation fa-2xl text-danger">
      </i>
      <div>
       <div class="fw-bold">
        Check-in failed
       </div>
       <small class="text-muted" id="fbErrorMessage">
        —
       </small>
      </div>
     </div>
    </div>
   </section>
   <!-- Recent activity chips (compact, optional) -->
   <section class="recent-activity d-none" id="recentActivity">
    <div class="app-card p-3">
     <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="fw-semibold">
       Recent check-ins
      </div>
      <button class="btn btn-sm btn-light" id="clearRecentBtn">
       <i class="fa-solid fa-broom me-2">
       </i>
       Clear
      </button>
     </div>
     <div class="d-flex flex-wrap gap-2" id="recentList">
     </div>
    </div>
   </section>
  </main>
  <!-- Kiosk Footer Minimal Branding (common component) -->
  <footer class="kiosk-footer py-2 px-3 d-flex align-items-center justify-content-center">
   <small class="text-muted">
    © 2025 Attendance System
   </small>
  </footer>
  <!-- Bootstrap 5 JS -->
  <script crossorigin="anonymous" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script>
   // Header clock (common component)
(function() {
    function tick() {
        var el = document.getElementById('kioskClock');
        if (el) {
            var d = new Date();
            el.textContent = d.toLocaleTimeString();
        }
    }
    tick();
    setInterval(tick, 1000);
})();

// Mock schedule/class info fetch for kiosk location
const kioskState = {
    locationId: 'LOC-001',
    locationName: 'Kiosk A - North Entrance',
    currentClassSchedule: {
        courseName: 'Algebra II',
        teacherName: 'Ms. Rivera',
        periodInfo: 'Period 3 • 10:15 AM - 11:05 AM'
    },
    scanStatus: 'idle',
    lastScannedStudent: null,
    lastCheckInTime: null,
    errorMessage: null
};

const knownStudents = new Map([
    ['S10001', {
        id: 'S10001',
        name: 'Alex Johnson'
    }],
    ['S10002', {
        id: 'S10002',
        name: 'Priya Singh'
    }],
    ['S10003', {
        id: 'S10003',
        name: 'Miguel Santos'
    }],
    ['S10004', {
        id: 'S10004',
        name: 'Emily Chen'
    }],
    ['S10005', {
        id: 'S10005',
        name: 'Jordan Lee'
    }],
    ['S10006', {
        id: 'S10006',
        name: 'Fatima Noor'
    }]
]);
const checkedInSet = new Set();

function setClassInfo() {
    document.getElementById('locationName').textContent = kioskState.locationName;
    document.querySelector('.class-title').textContent = kioskState.currentClassSchedule.courseName;
    document.getElementById('teacherName').textContent = kioskState.currentClassSchedule.teacherName;
    document.getElementById('periodInfo').textContent = kioskState.currentClassSchedule.periodInfo;
}

function setScannerReady(isReady = true) {
    const text = document.getElementById('scannerStatusText');
    text.textContent = isReady ? 'Ready for scan' : 'Processing…';
    document.querySelector('.scanner-viewfinder').classList.toggle('processing', !isReady);
}

function showFeedbackSuccess(name) {
    const success = document.getElementById('feedbackSuccess');
    const error = document.getElementById('feedbackError');
    error.classList.add('d-none');
    document.getElementById('fbStudentName').textContent = name;
    const t = new Date();
    const timeStr = t.toLocaleTimeString();
    document.getElementById('fbCheckinTime').textContent = timeStr;
    success.classList.remove('d-none');
    success.classList.add('show');
    setTimeout(() => {
        success.classList.remove('show');
        success.classList.add('d-none');
    }, 3500);
}

function showFeedbackError(msg) {
    const success = document.getElementById('feedbackSuccess');
    const error = document.getElementById('feedbackError');
    success.classList.add('d-none');
    document.getElementById('fbErrorMessage').textContent = msg;
    error.classList.remove('d-none');
    error.classList.add('show');
    setTimeout(() => {
        error.classList.remove('show');
        error.classList.add('d-none');
    }, 4000);
}

function addRecentChip(studentName, status) {
    const container = document.getElementById('recentList');
    const wrap = document.getElementById('recentActivity');
    wrap.classList.remove('d-none');
    const chip = document.createElement('span');
    chip.className = 'badge-soft ' + (status === 'success' ? 'success' : 'error');
    chip.innerHTML = `<i class="fa-solid ${status==='success' ? 'fa-circle-check' : 'fa-triangle-exclamation'}"></i> ${studentName} <small class="text-muted ms-1">${new Date().toLocaleTimeString()}</small>`;
    container.prepend(chip);
    // limit to last 10
    while (container.children.length > 10) {
        container.removeChild(container.lastChild);
    }
}

// Mock API call to check-in
function apiCheckIn(studentId) {
    // Simulate latency
    return new Promise((resolve, reject) => {
        setTimeout(() => {
            if (!knownStudents.has(studentId)) {
                reject({
                    code: 'NOT_FOUND',
                    message: 'Student ID not recognized.'
                });
                return;
            }
            if (checkedInSet.has(studentId)) {
                reject({
                    code: 'DUPLICATE',
                    message: 'Already checked in for this session.'
                });
                return;
            }
            checkedInSet.add(studentId);
            const student = knownStudents.get(studentId);
            resolve({
                status: 'success',
                studentName: student.name,
                time: new Date().toISOString()
            });
        }, 600);
    });
}

async function processScan(raw) {
    const id = (raw || '').trim();
    if (!id) {
        return;
    }
    kioskState.scanStatus = 'processing';
    setScannerReady(false);
    try {
        const res = await apiCheckIn(id);
        kioskState.scanStatus = 'success';
        kioskState.lastScannedStudent = res.studentName;
        kioskState.lastCheckInTime = res.time;
        showFeedbackSuccess(res.studentName);
        addRecentChip(res.studentName, 'success');
        Swal.fire({
            icon: 'success',
            title: 'Check-in Successful',
            text: `Welcome, ${res.studentName}!`,
            timer: 1600,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
        });
    } catch (err) {
        kioskState.scanStatus = 'error';
        kioskState.errorMessage = err?.message || 'Unknown error';
        showFeedbackError(kioskState.errorMessage);
        addRecentChip('Error', 'error');
        Swal.fire({
            icon: 'error',
            title: 'Check-in Failed',
            text: kioskState.errorMessage,
            timer: 2200,
            showConfirmButton: false,
            position: 'top-end',
            toast: true
        });
    } finally {
        setScannerReady(true);
    }
}

// Keyboard wedge scanner handler
let buffer = '';
let lastKeyTime = Date.now();
const INTER_KEY_TIMEOUT = 80; // ms, separates manual typing vs scanner

window.addEventListener('keydown', (e) => {
    // Allow Esc to clear buffer
    if (e.key === 'Escape') {
        buffer = '';
        return;
    }
    const now = Date.now();
    if (now - lastKeyTime > 250) {
        buffer = '';
    }
    lastKeyTime = now;
    if (e.key === 'Enter') {
        e.preventDefault();
        const payload = buffer;
        buffer = '';
        processScan(payload);
    } else if (e.key.length === 1) {
        buffer += e.key;
    }
});

// Hidden input approach (for certain scanners/browsers)
function focusHiddenInput() {
    const input = document.getElementById('scanInput');
    if (input) {
        input.value = '';
        input.focus();
    }
}

document.getElementById('refocusBtn').addEventListener('click', focusHiddenInput);

document.getElementById('simulateScanBtn').addEventListener('click', async () => {
    const {
        value: id
    } = await Swal.fire({
        title: 'Simulate Scan',
        input: 'select',
        inputOptions: {
            S10001: 'Alex Johnson (S10001)',
            S10002: 'Priya Singh (S10002)',
            S10003: 'Miguel Santos (S10003)',
            S10004: 'Emily Chen (S10004)',
            S10005: 'Jordan Lee (S10005)',
            S10006: 'Fatima Noor (S10006)'
        },
        inputPlaceholder: 'Choose a student ID',
        showCancelButton: true,
        confirmButtonText: 'Scan',
        cancelButtonText: 'Cancel'
    });
    if (id) {
        processScan(id);
    }
});

document.getElementById('clearRecentBtn')?.addEventListener('click', () => {
    document.getElementById('recentList').innerHTML = '';
});

// Connection heartbeat simulation
function simulateConnection() {
    const dot = document.getElementById('connDot');
    const text = document.getElementById('connText');
    // Randomly toggle connection for demo
    const online = Math.random() > 0.05; // 95% uptime demo
    if (online) {
        dot.classList.remove('warning', 'error');
        dot.classList.add('success');
        text.textContent = 'Connected';
    } else {
        dot.classList.remove('success');
        dot.classList.add('warning');
        text.textContent = 'Reconnecting…';
    }
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') focusHiddenInput();
});

// Initialize
window.addEventListener('DOMContentLoaded', () => {
    setClassInfo();
    setScannerReady(true);
    focusHiddenInput();
    setInterval(simulateConnection, 5000);
});
  </script>
 </body>
</html>
